sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/MessagePopover","sap/m/MessagePopoverItem","sap/m/MessageBox","sap/m/FormattedText","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/library"],function(e,t,r,a,o,s,n,i,d,l){"use strict";var g=l.URLHelper;return e.extend("StaffingApp.horvath.controller.Detail",{onInit:function(){var e=new t({resourcesCount:0,busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading"),btnVisible:true,aInputStaffed:[],totalUnassignCap:0,selectedView:"DAY"});this.getView().setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},onExit:function(){this.getRouter().getRoute("list").detachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("object").detachPatternMatched(this._onObjectMatched,this)},onChange:function(e,t){var r=e.getSource(),a=r.getBindingContext("detailView").sPath,o=e.getSource().getModel("detailView").getProperty("/aChangedSPath"),s=e.getSource().getModel("detailView").getProperty("/aInputStaffed");if(!e.getParameter("newValue")&&o.length>0){var n=o.findIndex(e=>e.sPath===a);o.splice(n,1)}else{var i=o.filter(e=>e.sPath===a);if(i.length>0){i[0].value=e.getParameter("newValue")}else{o.push(Object.assign(t,{sPath:a,value:e.getParameter("newValue"),inputId:e.getParameter("id")}))}}e.getSource().getModel("detailView").refresh(true)},onSave:function(e){var t=e.getSource().getModel("detailView");var r=t.getProperty("/selectedView");var a=r==="DAY"?.5:4;var n=new s("FormattedText_"+(new Date).getTime(),{htmlText:this.getResourceBundle().getText("savedMessage",[r])});for(var i in t.getProperty("/aChangedSPath")){if(+t.getProperty("/aChangedSPath")[i].value%a!==0){o.error(this.getResourceBundle().getText("errorHrDayText"));return}}o.confirm(n,{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK,onClose:function(e){if(e==="CANCEL")return;this._updateModel()}.bind(this)})},onSegmentChanged:function(){this.getModel("detailView").refresh(true)},onEmployeePress:function(e,t){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","EndColumnFullScreen");this.getOwnerComponent().getRouter().navTo("detailDetail",{object:encodeURIComponent(JSON.stringify(t))})},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);sap.ui.getCore().getMessageManager().removeAllMessages();this.getRouter().navTo("list")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded")}},onCollapseAll:function(){this.byId("idTreeTable").collapseAll()},onExpandAll:function(){this.byId("idTreeTable").expandToLevel(3)},_onObjectMatched:async function(e){var t=e.getParameter("arguments"),r=this.getModel("detailView").getProperty("/aChangedSPath")||[];this.oContextObj=JSON.parse(decodeURIComponent(t.object));sap.ui.getCore().getMessageManager().removeAllMessages();this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");r.forEach(e=>{sap.ui.getCore().byId(e.inputId).setValue("")});this.getModel("detailView").setData(Object.assign(this.getModel("detailView").getData(),this.oContextObj,{StartDate:new Date(this.oContextObj.StartDate),EndDate:new Date(this.oContextObj.EndDate),aChangedSPath:[],aTimeRecUpdate:[],aPlannedValueChanged:[]}));this.getModel("detailView").setProperty("/busy",true);await this._fetchResources(this.oContextObj)},_fetchResources:async function(e){var t=this.getCurrentPeriod();return new Promise((r,a)=>{Promise.all(this.getResourcePath(e,t).map(e=>this.fetchResources(e))).then(async function(e){var a={Node:[]},o=this.getModel("detailView"),[,s,l,g,u,h]=e.map(({results:e})=>e);o.setProperty("/resourcesCount",e[0].results.length);for(var c in e[0].results){var m=e[0].results[c],P=l.reduce((e,t)=>{if(t.Version==="2"&&t.WorkPackage===m.WorkPackageID){return e+ +t.Quantity}return e},0);a.Node.push({Name:[m.WorkPackageName,m.WorkPackageID].join(" "),Baseline:P>0?P:null,bLink:false,bInputVisible:false,Node:[]});if(s.length===0){continue}var f=s.filter(e=>{if(e.WorkPackage===m.WorkPackageID){return e}}),p=a.Node[a.Node.length-1],M=p.Node,y=await this.fetchResources({oModel:this.getView().getModel("EmployeeCapacity"),sPath:"/YY1_EMP_CAPACITY_API",aFilters:l.filter(e=>e.Version==="1").map(e=>new n("PersonWorkAgreement",d.EQ,e.PersonWorkAgreement)),aSort:[new i("EngagementProject",false),new i("YearMth",false)]});for(var D in f){var C=f[D],A=u.find(e=>e.PersonWorkAgreement===C.PersonWorkAgreement&&e.YearMth===C.YearMth),V=g.find(e=>e.ProjDmndRsceAssgmt===C.PersonWorkAgreement&&e.YearMth===C.YearMth),{ContractTypeName:k,...b}=C,R=h.find(e=>e.PersonWorkAgreement===C.PersonWorkAgreement&&e.YearMth===C.YearMth&&e.WorkPackageID===m.WorkPackageID);p.ContractTypeName=p.ContractTypeName||C.ContractTypeName;if(M.length===0||!M.some(e=>e["WorkAgrementID"]===C.PersonWorkAgreement)){var w=l.reduce((e,t)=>{if(t.Version==="2"&&t.WorkPackage===m.WorkPackageID&&t.PersonWorkAgreement===C.PersonWorkAgreement){return e+ +t.Quantity}return e},0);M.push({...b,...{WorkAgrementID:C.PersonWorkAgreement,Name:C.PersonFullName,Baseline:w>0?w:null,bLink:false,bInputVisible:false,Node:[]}})}var v=M[M.length-1],{ServiceCostLevelName:S,ContractTypeName:k,...b}=C;if(+C.YearMth<t.nMinMth){if(!v.Node.some(e=>!!e.preMth)){v.Node.push({Name:this.getResourceBundle().getText("Sumofpreviousmonths"),preMth:true,bLink:false,bInputVisible:false,Node:[]})}A&&+A.RecordedQuantity>0&&+A.RecordedQuantity!==+C.PlndEffortQty&&V?o.getProperty("/aTimeRecUpdate").push({ProjDmndRsceAssgmtDistrUUID:V.ProjDmndRsceAssgmtDistrUUID,value:A.RecordedQuantity,PersonWorkAgreement:C.PersonWorkAgreement,YearMth:C.YearMth}):"";var W=v.Node.filter(e=>e.preMth),j=y.results.filter(e=>e.PersonWorkAgreement===C.PersonWorkAgreement&&e.YearMth===C.YearMth),I=W[0].Node,T=l.find(e=>e.PersonWorkAgreement===C.PersonWorkAgreement&&e.Version==="1").to_ResourceDemand.to_ResourceDemandDistribution.results.find(e=>e.CalendarYear+e.CalendarMonth.padStart(2,"0")===C.YearMth);if(b.PlndEffortQty>0){o.getProperty("/aPlannedValueChanged").push(Object.assign(T,{PersonWorkAgreement:C.PersonWorkAgreement,Quantity:C.PlndEffortQty,YearMth:C.YearMth}))}I.push(this._returnMthDist({...b,Level:C.ServiceCostLevelName,...A?A:"",...{bLink:false,bInputVisible:false,ProjDmndRsceAssgmtDistrUUID:V?V.ProjDmndRsceAssgmtDistrUUID:"",WriteOffs:R?R.WrittenOffQuantity:null,aEmpRemaingDays:j},aProjEng:l,preMth:true}));this._calculateValues(W[0])}else{if(!v.Node.some(e=>!!e.upcomMth)){v.Node.push({Name:this.getResourceBundle().getText("Sumofupcomingmonths"),upcomMth:true,bLink:false,bInputVisible:false,Node:[]})}var Y=v.Node.filter(e=>e.upcomMth),j=y.results.filter(e=>e.PersonWorkAgreement===C.PersonWorkAgreement&&e.YearMth===C.YearMth),U=Y[0].Node,T=l.find(e=>e.PersonWorkAgreement===C.PersonWorkAgreement&&e.Version==="1").to_ResourceDemand.to_ResourceDemandDistribution.results.find(e=>e.CalendarYear+e.CalendarMonth.padStart(2,"0")===C.YearMth);if(b.PlndEffortQty>0){o.getProperty("/aPlannedValueChanged").push(Object.assign(T,{PersonWorkAgreement:C.PersonWorkAgreement,Quantity:C.PlndEffortQty,YearMth:C.YearMth}))}U.push(this._returnMthDist({...b,Level:C.ServiceCostLevelName,...A?A:"",...{nStaffedNew:+C.PlndEffortQty,bLink:true,bInputVisible:true,ProjDmndRsceAssgmtDistrUUID:V?V.ProjDmndRsceAssgmtDistrUUID:"",WriteOffs:R?R.WrittenOffQuantity:null,aEmpRemaingDays:j,aProjEng:l,preMth:false}}));this._calculateValues(Y[0])}this._calculateValues(v)}for(var _ in p.Node){var N=p.Node[_];N=Object.assign(N,{EstTillCompletion:+N.Staffed-+N.TimeRecordings,EstAtCompletion:+N.Staffed,DeltaELPlanned:+N.Staffed-+N.Baseline})}this._calculateValues(p);p=Object.assign(p,{EstTillCompletion:+p.Staffed-+p.TimeRecordings,EstAtCompletion:+p.Staffed,DeltaELPlanned:+p.Staffed-+p.Baseline})}this.getModel("detailView").setProperty("/totalUnassignCap",a.Node.map(e=>e.UnassignedCap).reduce((e,t)=>+e+ +t,0));this.getModel("detailView").setProperty("/resource",a);this.getModel("detailView").refresh(true);this.getModel("detailView").setProperty("/busy",false);r(this.getModel("detailView").getProperty("/resource"))}.bind(this)).catch(function(e){this.getModel("detailView").setProperty("/busy",false);a(e)}.bind(this))})},_onMetadataLoaded:function(){},_fetchCsrfToken:function(e){return new Promise((t,r)=>{try{e.refreshSecurityToken(function(r){t(e.getSecurityToken())}.bind(this))}catch(e){this.getModel("detailView").setProperty("/busy",false);r(e)}})},_updateModel:async function(){this.getModel("detailView").setProperty("/busy",false);var e=this.getModel("ProjectDemand"),t=this.getModel("PROJ_ENGMT_UPDATE_SRV"),r=this.getModel("detailView"),a=r.getProperty("/aChangedSPath"),s=r.getProperty("/aTimeRecUpdate"),n=r.getProperty("/aPlannedValueChanged"),i={};if(a.length===0&&s.length===0&&n.length===0){return}this.getModel("detailView").setProperty("/busy",true);e.setUseBatch(true);e.setDeferredGroups(["BatchQuery"]);t.setUseBatch(true);t.setDeferredGroups(["BatchQuery"]);i.oDetailModel=r;i.mParameters={groupId:"BatchQuery",method:"PATCH",headers:{"X-CSRF-Token":await this._fetchCsrfToken(e)}};i.oModel=e;for(var d in a){var l=a[d],g=l.aProjEng.find(e=>e.PersonWorkAgreement===l.PersonWorkAgreement&&e.Version==="1").to_ResourceDemand.to_ResourceDemandDistribution.results.find(e=>e.CalendarYear+e.CalendarMonth.padStart(2,"0")===l.YearMth),u=r.getProperty("/selectedView")==="DAY"?Math.round(l.value*8).toString():l.value.toString();if(n.length>0&&!!n.some(e=>e.PersonWorkAgreement===l.PersonWorkAgreement&&e.YearMth===l.YearMth)){var h=n.find(e=>e.PersonWorkAgreement===l.PersonWorkAgreement&&e.YearMth===l.YearMth);h.Quantity=u}else{n.push(Object.assign(g,{PersonWorkAgreement:l.PersonWorkAgreement,Quantity:u,YearMth:l.YearMth}))}i.sKey=e.createKey("/A_ProjDmndRsceAssgmtDistr",{ProjDmndRsceAssgmtDistrUUID:l.ProjDmndRsceAssgmtDistrUUID});i.oPayload={ProjDmndRsceAssgmtDistrQty:u};i.mParameters.changeSetId="changeSet_"+(new Date).getTime();this.updateResource(i)}for(var d in s){var l=s[d];i.sKey=e.createKey("/A_ProjDmndRsceAssgmtDistr",{ProjDmndRsceAssgmtDistrUUID:l.ProjDmndRsceAssgmtDistrUUID});i.oPayload={ProjDmndRsceAssgmtDistrQty:l.value.toString()};i.mParameters.changeSetId="changeSet_"+(new Date).getTime();this.updateResource(i)}var c=await this.batchChange(i);i.oModel=t;for(var d in n){var l=n[d];i.sKey=t.createKey("/A_EngmntProjRsceDmndDistr",{WorkPackage:l.WorkPackage,ResourceDemand:l.ResourceDemand,Version:l.Version,CalendarMonth:l.CalendarMonth.toString().padStart(3,"0"),CalendarYear:l.CalendarYear});i.oPayload={UnitOfMeasure:"H",Quantity:l.Quantity};i.mParameters.changeSetId="changeSet_"+(new Date).getTime();this.updateResource(i)}var m=await this.batchChange(i);Promise.all([c,m]).then(async function(e){var t=this.getModel("message"),r=t.getData()[t.getData().length-1],a=this.getModel("detailView").getProperty("/aChangedSPath");a.forEach(function(e){sap.ui.getCore().byId(e.inputId).setValue("")});this.getModel("detailView").setProperty("/aChangedSPath",[]);this.getModel("detailView").setProperty("/aTimeRecUpdate",[]);this.getModel("detailView").setProperty("/aPlannedValueChanged",[]);this.getModel("ProjectDemand").setUseBatch(false);this.getModel("PROJ_ENGMT_UPDATE_SRV").setUseBatch(false);await this._fetchResources(this.oContextObj);this.getModel("detailView").refresh(true);o.success(r.message)}.bind(this)).catch(function(e){for(var t in a){this.getModel("ProjectDemand").resetChanges([a[t].sPath],true)}this.getModel("ProjectDemand").setUseBatch(false);this.getModel("PROJ_ENGMT_UPDATE_SRV").setUseBatch(false);this.getModel("detailView").setProperty("/busy",false)}.bind(this))},_returnMthDist:function(e){var t=+e.aEmpRemaingDays.reduce((e,t)=>e+ +t.PlndEffortQty,0);return{...e,...{WorkPackage:e.WorkPackage,Name:this.formatter.returnDataFormat("MMM yyyy").format(new Date([e.YearMth.substr(0,4),e.YearMth.substr(4,2),"01"].join("-"))),YearMth:e.YearMth,TimeRecordings:+e.RecordedQuantity>0?+e.RecordedQuantity:null,Staffed:+e.PlndEffortQty,UnassignedCap:!e.preMth?+e.AvailabilityInHours-+e.AbsenceInHours-t:null,Writeoffs:e.WriteOffs,bLink:e.bLink,bInputVisible:e.bInputVisible,nProjectAssigned:t}}},_calculateValues:function(e){e.Staffed=e.Node.map(e=>e.Staffed).reduce((e,t)=>+e+ +t,0)||null;e.TimeRecordings=e.Node.map(e=>e.TimeRecordings).reduce((e,t)=>+e+ +t,0)||null;e.UnassignedCap=e.Node.map(e=>e.UnassignedCap).reduce((e,t)=>+e+ +t,0);e.Writeoffs=e.Node.map(e=>e.Writeoffs).reduce((e,t)=>+e+ +t,0)||null},_batchRun:function(e){var t=this.getModel("detailView").getProperty(e.sProperty),r=e.sProperty!=="/aPlannedValueChanged"?this.getModel("detailView").getProperty("/aPlannedValueChanged"):undefined;for(var a in t){var o=t[a];if(e.sProperty==="/aChangedSPath"){var s=o.aProjEng.find(e=>e.PersonWorkAgreement===o.PersonWorkAgreement&&e.Version==="1").to_ResourceDemand.to_ResourceDemandDistribution.results.find(e=>e.CalendarYear+e.CalendarMonth.padStart(2,"0")===o.YearMth),n=this.getModel("detailView").getProperty("/selectedView")==="DAY"&&e.sProperty==="/aChangedSPath"?Math.round(o.value*8).toString():o.value.toString();if(r.length>0&&!!r.some(e=>e.PersonWorkAgreement===o.PersonWorkAgreement&&e.YearMth===o.YearMth)){var i=r.find(e=>e.PersonWorkAgreement===o.PersonWorkAgreement&&e.YearMth===o.YearMth);i.Quantity=n}else{r.push(Object.assign(s,{PersonWorkAgreement:o.PersonWorkAgreement,Quantity:n,YearMth:o.YearMth}))}}if(e.sProperty==="/aChangedSPath"||e.sProperty==="/aTimeRecUpdate"){e.sKey=e.oModel.createKey(e.sKeyPath,{ProjDmndRsceAssgmtDistrUUID:o.ProjDmndRsceAssgmtDistrUUID});e.oPayload={ProjDmndRsceAssgmtDistrQty:n}}else{e.sKey=e.oModel.createKey(e.sKeyPath,{WorkPackage:o.WorkPackage,ResourceDemand:o.ResourceDemand,Version:o.Version,CalendarMonth:o.CalendarMonth.toString().padStart(3,"0"),CalendarYear:o.CalendarYear});e.oPayload={UnitOfMeasure:"H",Quantity:o.Quantity}}this.updateResource(e)}}})});