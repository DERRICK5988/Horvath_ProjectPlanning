sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/MessagePopover","sap/m/MessagePopoverItem","sap/m/MessageBox","sap/m/FormattedText","sap/m/library"],function(e,t,a,i,n,r,s,o,d,l){"use strict";var g=l.URLHelper;return e.extend("StaffingApp.horvath.controller.Detail",{onInit:function(){var e=new t({resourcesCount:0,busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading"),btnVisible:true,aChangedSPath:[],totalUnassignCap:30,selectedView:"HOUR"});debugger;this.getView().setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},onChange:function(e){var t=e.getSource(),a=t.getBindingInfo("value").binding.aBindings[0].getContext(),i=a.sPath,n=e.getSource().getModel("detailView").getProperty("/aChangedSPath");if(!e.getParameter("newValue")&&n.length>0){var r=n.findIndex(e=>e.sPath===i);n.splice(r,1);return}var s=n.filter(e=>e.sPath===i);if(s.length>0){s[0].value=e.getParameter("newValue");return}n.push({sPath:i,value:e.getParameter("newValue")})},onSave:function(e){var t=e.getSource().getModel("detailView"),a=new d("FormattedText",{htmlText:this.getResourceBundle().getText("savedMessage",[t.getProperty("/selectedView")])});o.confirm(a,{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK,onClose:function(e){if(e==="CANCEL"){return}this._updateModel()}.bind(this)})},onSegmentChanged:function(e){this.getModel("detailView").refresh(true)},onEmployeePress:function(e,t){debugger;this.getModel("appView").setProperty("/layout","EndColumnFullScreen");this.getOwnerComponent().getRouter().navTo("detailDetail",{object:encodeURIComponent(JSON.stringify(t))})},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);sap.ui.getCore().getMessageManager().removeAllMessages();this.getRouter().navTo("list")},onListUpdateFinished:function(e){var t,a=e.getParameter("total"),i=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(a){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[a])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}i.setProperty("/lineItemListTitle",t)}},onMessagesButtonPress:function(e){var t=e.getSource();if(!this._messagePopover){this._messagePopover=new r({items:{path:"message>/",template:new s({description:"{message>description}",type:"{message>type}",title:"{message>message}"})}});t.addDependent(this._messagePopover)}this._messagePopover.toggle(t)},onExit:function(){this.getRouter().getRoute("list").detachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("object").detachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){debugger;var t=e.getParameter("arguments"),r=JSON.parse(decodeURIComponent(t.object)),s={$expand:"PlanDataSet,PlanDataSet/ToStaffData"},o=[],d=[],l=[];sap.ui.getCore().getMessageManager().removeAllMessages();this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getModel("detailView").setData(Object.assign(this.getModel("detailView").getData(),r,{StartDate:new Date(r.StartDate),EndDate:new Date(r.EndDate)}));this.getModel("detailView").setProperty("/busy",true);l.push(new a("EngagementProject",i.EQ,r.ProjectID));o.push(new a("ProjectID",i.EQ,r.ProjectID));Promise.all([this._fetchResources(this.getView().getModel(),"/WorkpackageSet",o,s,"",[new n("WorkPackageID",false)]),this._fetchResources(this.getView().getModel(),"/StaffingDataSet",o,"","",[new n("StaffedEmployee",false),new n("Period",false)]),this._fetchResources(this.getOwnerComponent().getModel("PROJ_ENGMT_UPDATE_SRV"),"/A_EngmntProjRsceSup",l),this._fetchResources(this.getView().getModel("TimeSheet"),"/YY1_TIME_RECORDING",o)]).then(function(e){var t={Node:[]},a=this.getModel("detailView"),i=e[1].results,n=e[2].results,r=this._getCurrentPeriod();a.setProperty("/resourcesCount",e[0].results.length);for(var s in e[0].results){var o=e[0].results[s],d=n.filter(e=>{if(e.Version==="2"&&e.WorkPackage===o.WorkPackageID){return e}}).map(e=>e.Quantity).reduce((e,t)=>+e+ +t,0);t.Node.push({Name:[o.WorkPackageName,o.WorkPackageID].join(" "),Baseline:d>0?d:null,Employee:false,inputVisible:false,Node:[]});if(i.length===0){continue}var l=[];l=i.filter((e,t)=>t===i.findIndex(t=>e.StaffedEmployee===t.StaffedEmployee&&e.WorkPackageID===t.WorkPackageID));for(var g in l){var u=l[g],f=t.Node[s].Node;if(u.WorkPackageID!==o.WorkPackageID){continue}var c=i.filter(function(e){if(e.WorkPackageID===u.WorkPackageID&&e.StaffedEmployee===u.StaffedEmployee){return e}});var h=c.filter(function(e){if(e.Version==="1"){return e}}).map(function(e){return e.StaffedEffort}).reduce((e,t)=>+e+ +t,0);var p=t.Node[t.Node.length-1];p.Staffed=h?+(p.Staffed?p.Staffed:0)+ +h:p.Staffed;f.push(Object.assign(u,{Name:u.StaffedEmployeeName,Staffed:h,StaffedDay:h?h/8:h,Employee:true,inputVisible:false,Node:[]}));var m=n.filter(e=>{if(e.Version==="1"&&e.WorkPackage===o.WorkPackageID&&e.PersonWorkAgreement===u.StaffedEmployee){return e}}),y=f[f.length-1];debugger;for(var M in c){var P=c[M],S=e[3].results.filter(function(e){if(e.MthYr===P.FcYear+P.Period.substring(1)&&e.WorkPackageID===u.WorkPackageID){return e}});if(+[P.FcYear,P.Period.substring(1)].join("")<r.nMinMth){if(y.Node.filter(e=>e.preMth).length===0){y.Node.push({Name:"Sum of previous months",preMth:true,Employee:false,inputVisible:false,Node:[]})}var w=y.Node.filter(e=>e.preMth),D=w[0].Node,R=S.length>0?+S[0].RecordedQuantity:null;D.push(this._returnMthDist(o,P,m,S,R,false,false))}else if(+[P.FcYear,P.Period.substring(1)].join("")>r.nMaxMth){if(y.Node.filter(e=>e.upcomMth).length===0){y.Node.push({Name:"Sum of upcoming months",upcomMth:true,Employee:false,inputVisible:false,Node:[]})}var C=y.Node.filter(e=>e.upcomMth),V=C[0].Node,R=P.Version==="1"?+P.StaffedEffort:null;V.push(this._returnMthDist(o,P,m,S,R,false,true))}else{var R=S.length>0&&+[P.FcYear,P.Period.substring(1)].join("")===r.nMinMth?+S[0].RecordedQuantity:P.Version==="1"&&+[P.FcYear,P.Period.substring(1)].join("")!==r.nMinMth?+P.StaffedEffort:null;y.Node.push(this._returnMthDist(o,P,m,S,R,false,true))}y.TimeRecordings=S.length>0?+(y.TimeRecordings?y.TimeRecordings:0)+ +S[0].RecordedQuantity:y.TimeRecordings}if(D&&D.length>0){this._sumPeriodDist(w,D)}if(V&&V.length>0){this._sumPeriodDist(C,V)}y.StaffedNew=y.Node.map(function(e){return e.StaffedNew}).reduce((e,t)=>+e+ +t,0);y.StaffedNew=y.StaffedNew?y.StaffedNew:null;y.StaffedNewDay=y.StaffedNew>0?y.StaffedNew/8:y.StaffedNew;p.StaffedNew=y.StaffedNew>0?+(p.StaffedNew?p.StaffedNew:0)+ +y.StaffedNew:p.StaffedNew;y.TimeRecordingsDay=y.TimeRecordings>0?y.TimeRecordings/8:y.TimeRecordings;p.TimeRecordings=y.TimeRecordings>0?+(p.TimeRecordings?p.TimeRecordings:0)+ +y.TimeRecordings:p.TimeRecordings;y.UnassignedCap=y.Node.map(function(e){return e.UnassignedCap}).reduce((e,t)=>+e+ +t,0);y.UnassignedCapDay=y.UnassignedCap>0?y.UnassignedCap/8:y.UnassignedCap}p.StaffedDay=p.Staffed>0?p.Staffed/8:p.Staffed;p.StaffedNewDay=p.StaffedDay>0?p.StaffedDay/8:p.StaffedDay;p.TimeRecordingsDay=p.TimeRecordings?+p.TimeRecordings/8:p.TimeRecordings;p.BaselineDay=p.Baseline>0?p.Baseline/8:p.Baseline}this.getView().getModel("detailView").setProperty("/resource",t);this.getView().getModel("detailView").refresh(true);this.getModel("detailView").setProperty("/busy",false);debugger}.bind(this)).catch(function(e){this.getModel("detailView").setProperty("/busy",false)}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearListListSelection();return}var a=t.getPath(),i=this.getResourceBundle(),n=e.getModel().getObject(a),r=n.ProjectID,s=n.ProjectName,o=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(a);o.setProperty("/shareSendEmailSubject",i.getText("shareSendEmailObjectSubject",[r]));o.setProperty("/shareSendEmailMessage",i.getText("shareSendEmailObjectMessage",[s,r,location.href]))},_onMetadataLoaded:function(){},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}},_updateModel:function(){var e=this.getModel("PROJ_ENGMT_UPDATE_SRV"),t=this.getView().getModel("detailView"),a=t.getProperty("/aChangedSPath");if(a.length===0){return}e.setDeferredGroups(["BatchQuery"]);this.getModel("detailView").setProperty("/busy",true);for(var i in a){var n=a[i],r=this.getModel("detailView").getProperty(a[i].sPath),s={};s.oModel=e;s.sKey=e.createKey("/A_EngmntProjRsceDmndDistr",{WorkPackage:r.WorkPackage,ResourceDemand:r.ResourceDemand,Version:"1",CalendarMonth:r.CalendarMonth,CalendarYear:r.CalendarYear});s.oPayload={UnitOfMeasure:"H",Quantity:t.getProperty("/selectedView")==="DAY"?(n.value*8).toString():n.value.toString()};s.mParameters={groupId:"BatchQuery",changeSetId:"BatchQuery",method:"PATCH"};this.updateModel(s)}e.submitChanges(Object.assign(s.mParameters,{success:function(e){var t=this.getModel("message"),a=this.getModel("detailView").getProperty("/aChangedSPath");if(t.getData()[0].type!=="Success"){for(var i in a){this.getModel("PROJ_ENGMT_UPDATE_SRV").resetChanges([a[i].sPath],true)}this.getModel("detailView").setProperty("/busy",false);return}this.getModel("detailView").setProperty("/aChangedSPath",[]);this.getModel("detailView").setProperty("/busy",false)}.bind(this),error:function(e){this.getModel("detailView").setProperty("/busy",false)}.bind(this)}))},_fetchResources:function(e,t,a,i,n,r){return new Promise(function(s,o){e.read(t,{filters:a,sorters:r,urlParameters:i,groupId:n,success:function(e,t){s(e)}.bind(this),error:function(e){o(e)}.bind(this)})})},_getCurrentPeriod:function(){var e=this.returnDataFormat("yyyyMM").format(new Date([(new Date).getFullYear(),(new Date).getMonth(),"01"].join("-"))),t=this.returnDataFormat("yyyyMM").format(new Date([(new Date).getFullYear(),(new Date).getMonth()+3,"01"].join("-")));return{nMinMth:+e,nMaxMth:+t}},_returnMthDist:function(e,t,a,i,n,r,s){var o=+(Math.random()*10+-5),d=o?o/8:null;return{WorkPackage:e.WorkPackageID,Name:this.returnDataFormat("MMM yyyy").format(new Date([t.FcYear,t.Period,"01"].join("-"))),CalendarMonth:t.Period,CalendarYear:t.FcYear,ResourceDemand:a[0].ResourceDemand,ResourceSupply:a[0].ResourceSupply,TimeRecordings:i.length>0?+i[0].RecordedQuantity:null,TimeRecordingsDay:i.length>0&&i[0].RecordedQuantity?+i[0].RecordedQuantity/8:null,Staffed:t.Version==="1"?+t.StaffedEffort:null,StaffedDay:t.Version==="1"&&t.StaffedEffort?+t.StaffedEffort/8:null,StaffedNew:n,StaffedNewDay:n?n/8:null,UnassignedCap:o,UnassignedCapDay:d,Employee:r,inputVisible:s}},_sumPeriodDist:function(e,t){e[0].Staffed=t.map(function(e){return e.Staffed}).reduce((e,t)=>+e+ +t,0);e[0].Staffed=e[0].Staffed?e[0].Staffed:null;e[0].StaffedDay=e[0].StaffedDay?e[0].StaffedDay/8:e[0].StaffedDay;e[0].StaffedNew=t.map(function(e){return e.StaffedNew}).reduce((e,t)=>+e+ +t,0);e[0].StaffedNew=e[0].StaffedNew?e[0].StaffedNew:null;e[0].StaffedNewDay=e[0].StaffedDay?e[0].StaffedDay/8:e[0].StaffedDay;e[0].TimeRecordings=t.map(function(e){return e.TimeRecordings}).reduce((e,t)=>+e+ +t,0);e[0].TimeRecordings=e[0].TimeRecordings?e[0].TimeRecordings:null;e[0].TimeRecordingsDay=e[0].TimeRecordings?e[0].TimeRecordings/8:null;e[0].UnassignedCap=t.map(function(e){return e.UnassignedCap}).reduce((e,t)=>+e+ +t,0);e[0].UnassignedCap=e[0].UnassignedCap?e[0].UnassignedCap/8:null;e[0].UnassignedCapDay=e[0].UnassignedCapDay?e[0].UnassignedCapDay/8:null}})});