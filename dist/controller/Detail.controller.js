sap.ui.define(["./BaseController","../model/models","../model/formatter","sap/m/MessagePopover","sap/m/MessagePopoverItem","sap/m/MessageBox","sap/m/FormattedText","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/library"],function(e,t,r,a,s,o,i,n,l,d,u){"use strict";var g=u.URLHelper;var r=r;return e.extend("StaffingApp.horvath.controller.Detail",{onInit:function(){this.getView().setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(t.getDetailModel.call(this),"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},onExit:function(){this.getRouter().getRoute("list").detachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("object").detachPatternMatched(this._onObjectMatched,this)},onChange:function(e,t){var r=e.getSource(),a=r.getBindingContext("detailView").sPath,s=e.getSource().getModel("detailView").getProperty("/aChangedSPath"),o=e.getSource().getModel("detailView").getProperty("/aInputStaffed");t.bUpdate=e.getParameter("newValue")?true:false;if(!e.getParameter("newValue")&&s.length>0){var i=s.findIndex(e=>e.sPath===a);s.splice(i,1)}else{var n=s.filter(e=>e.sPath===a);if(n.length>0){n[0].value=e.getParameter("newValue")}else{s.push(Object.assign(t,{sPath:a,value:e.getParameter("newValue"),inputId:e.getParameter("id")}))}}e.getSource().getModel("detailView").refresh(true)},onSave:function(e){var t=e.getSource().getModel("detailView");var r=t.getProperty("/selectedView");var a=r==="DAY"?.5:4;var s=new i("FormattedText_"+(new Date).getTime(),{htmlText:this.getResourceBundle().getText("savedMessage",[r])});for(var n in t.getProperty("/aChangedSPath")){if(+t.getProperty("/aChangedSPath")[n].value%a!==0){o.error(this.getResourceBundle().getText("errorHrDayText"));return}}o.confirm(s,{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK,onClose:function(e){if(e==="CANCEL")return;this._request()}.bind(this)})},onSegmentChanged:function(){this.getModel("detailView").refresh(true)},onEmployeePress:function(e,t){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","EndColumnFullScreen");this.getOwnerComponent().getRouter().navTo("detailDetail",{object:encodeURIComponent(JSON.stringify(t))})},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);sap.ui.getCore().getMessageManager().removeAllMessages();this.getRouter().navTo("list")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded")}},onCollapseAll:function(){this.byId("idTreeTable").collapseAll()},onExpandAll:function(){this.byId("idTreeTable").expandToLevel(3)},_onObjectMatched:async function(e){var t=e.getParameter("arguments"),r=this.getModel("detailView").getProperty("/aChangedSPath")||[];this.oContextObj=JSON.parse(decodeURIComponent(t.object));sap.ui.getCore().getMessageManager().removeAllMessages();this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");r.forEach(e=>{sap.ui.getCore().byId(e.inputId).setValue("")});this.getModel("detailView").setData(Object.assign(this.getModel("detailView").getData(),this.oContextObj,{StartDate:new Date(this.oContextObj.StartDate),EndDate:new Date(this.oContextObj.EndDate),aChangedSPath:[],aDeletion:[]}));this.getModel("detailView").setProperty("/busy",true);await this._fetchResources(this.oContextObj);this.getModel("detailView").setProperty("/busy",false)},_fetchResources:async function(e){var t=this.getCurrentPeriod();return new Promise((r,a)=>{Promise.all(this.getResourcePath(e,t).map(e=>this.fetchResources(e))).then(async function(e){var a={Node:[]},s=this.getModel("detailView"),[,o,i,u,g,c,h]=e.map(({results:e})=>e);s.setProperty("/resourcesCount",e[0].results.length);for(var m in e[0].results){var p=e[0].results[m],f=i.reduce((e,t)=>{if(t.Version==="2"&&t.WorkPackage===p.WorkPackageID){return e+ +t.Quantity}return e},0);a.Node.push({Name:[p.WorkPackageName,p.WorkPackageID].join(" "),Baseline:f>0?f:null,bLink:false,bInputVisible:false,Node:[]});if(o.length===0){continue}var P=o.filter(e=>{if(e.WorkPackage===p.WorkPackageID){return e}}),D=a.Node[a.Node.length-1],M=D.Node,y=await this.fetchResources({oModel:this.getView().getModel("EmployeeCapacity"),sPath:"/YY1_EMP_CAPACITY_API",aFilters:i.filter(e=>e.Version==="1").map(e=>new n("PersonWorkAgreement",d.EQ,e.PersonWorkAgreement)),aSort:[new l("EngagementProject",false),new l("YearMth",false)]});for(var R in P){var b=P[+R],C=g.find(e=>e.PersonWorkAgreement===b.PersonWorkAgreement&&e.WorkPackageID===p.WorkPackageID&&e.YearMth===b.YearMth),k=u.find(e=>e.ProjectElement===p.WorkPackageID&&e.ProjDmndRsceAssgmt===b.PersonWorkAgreement&&e.YearMth===b.YearMth),w=h.find(e=>e.ProjectElement===p.WorkPackageID&&e.PersonWorkAgreement===b.PersonWorkAgreement&&e.YearMth===b.YearMth),{ContractTypeName:V,...v}=b,I=c.find(e=>e.PersonWorkAgreement===b.PersonWorkAgreement&&e.YearMth===b.YearMth&&e.WorkPackageID===p.WorkPackageID);D.ContractTypeName=D.ContractTypeName||b.ContractTypeName;if(M.length===0||!M.some(e=>e["WorkAgrementID"]===b.PersonWorkAgreement)){var S=i.reduce((e,t)=>{if(t.Version==="2"&&t.WorkPackage===p.WorkPackageID&&t.PersonWorkAgreement===b.PersonWorkAgreement){return e+ +t.Quantity}return e},0);M.push({...v,...{WorkAgrementID:b.PersonWorkAgreement,Name:b.PersonFullName,Baseline:S>0?S:null,bLink:false,bInputVisible:false,Node:[]}})}var A=M[M.length-1],{ServiceCostLevelName:j,ContractTypeName:V,...v}=b;if(+b.YearMth<t.nMinMth){if(!A.Node.some(e=>!!e.preMth)){A.Node.push({Name:this.getResourceBundle().getText("Sumofpreviousmonths"),preMth:true,bLink:false,bInputVisible:false,Node:[]})}C&&+C.RecordedQuantity>0&&+C.RecordedQuantity!==+b.PlndEffortQty&&k?s.getProperty("/aChangedSPath").push(Object.assign(b,k,w,{bTimeRecUpdate:true,value:C.RecordedQuantity})):"";(!C||+C.RecordedQuantity===0)&&+b.PlndEffortQty>0&&k?s.getProperty("/aDeletion").push(Object.assign(b,k,w)):"";var U=A.Node.filter(e=>e.preMth),W=y.results.filter(e=>e.PersonWorkAgreement===b.PersonWorkAgreement&&e.YearMth===b.YearMth),N=U[0].Node;N.push(this._returnMthDist({...v,Level:b.ServiceCostLevelName,...C?C:"",...{bLink:false,bInputVisible:false,ProjDmndRsceAssgmtDistrUUID:k?k.ProjDmndRsceAssgmtDistrUUID:"",ProjDmndRsceReqDistrUUID:w?w.ProjDmndRsceReqDistrUUID:"",WriteOffs:I?I.WrittenOffQuantity:null,aEmpRemaingDays:W},aProjEng:i,preMth:true}));this._calculateValues(U[0])}else{if(!A.Node.some(e=>!!e.upcomMth)){A.Node.push({Name:this.getResourceBundle().getText("Sumofupcomingmonths"),upcomMth:true,bLink:false,bInputVisible:false,Node:[]})}var T=A.Node.filter(e=>e.upcomMth),W=y.results.filter(e=>e.PersonWorkAgreement===b.PersonWorkAgreement&&e.YearMth===b.YearMth),_=T[0].Node,E=i.find(e=>e.WorkPackage===p.WorkPackageID&&e.PersonWorkAgreement===b.PersonWorkAgreement&&e.Version==="1").to_ResourceDemand.to_ResourceDemandDistribution.results.find(e=>e.CalendarYear+e.CalendarMonth.padStart(2,"0")===b.YearMth);_.push(this._returnMthDist({...v,Level:b.ServiceCostLevelName,...C?C:"",...{nStaffedNew:+b.PlndEffortQty,bLink:true,bInputVisible:true,ProjDmndRsceAssgmtDistrUUID:k?k.ProjDmndRsceAssgmtDistrUUID:"",ProjDmndRsceReqDistrUUID:w?w.ProjDmndRsceReqDistrUUID:"",WriteOffs:I?I.WrittenOffQuantity:null,aEmpRemaingDays:W,aProjEng:i,preMth:false}}));this._calculateValues(T[0])}this._calculateValues(A)}for(var O in D.Node){var Y=D.Node[O];Y=Object.assign(Y,{EstTillCompletion:+Y.Staffed-+Y.TimeRecordings,EstAtCompletion:+Y.Staffed,DeltaELPlanned:+Y.Staffed-+Y.Baseline})}this._calculateValues(D);D=Object.assign(D,{EstTillCompletion:+D.Staffed-+D.TimeRecordings,EstAtCompletion:+D.Staffed,DeltaELPlanned:+D.Staffed-+D.Baseline})}this.getModel("detailView").setProperty("/totalUnassignCap",a.Node.map(e=>e.UnassignedCap).reduce((e,t)=>+e+ +t,0));this.getModel("detailView").setProperty("/resource",a);this.getModel("detailView").refresh(true);r(this.getModel("detailView").getProperty("/resource"))}.bind(this)).catch(function(e){this.getModel("detailView").setProperty("/busy",false);a(e)}.bind(this))})},_onMetadataLoaded:function(){},_fetchCsrfToken:function(e){return new Promise((t,r)=>{try{e.refreshSecurityToken(function(r){t(e.getSecurityToken())}.bind(this))}catch(e){this.getModel("detailView").setProperty("/busy",false);r(e)}})},_request:async function(){this.getModel("detailView").setProperty("/busy",false);var e=this.getModel("ProjectDemand"),t=this.getModel("detailView"),r=t.getProperty("/aChangedSPath"),a=t.getProperty("/aDeletion"),s={};if(r.length===0&&a.length===0){return}this.getModel("detailView").setProperty("/busy",true);e.attachBatchRequestCompleted(this._batchRequestCompleted,this);this.csrfToken=await this._fetchCsrfToken(e);if(a.length>0){s.mParameters={groupId:"BatchDelete",changeSetId:"changeSetId1",headers:{"X-CSRF-Token":this.csrfToken}};e.setDeferredGroups(["BatchDelete"]);s.oModel=e;for(var o in a){var i=a[o];s.sKey=e.createKey("/A_ProjDmndRsceAssgmtDistr",{ProjDmndRsceAssgmtDistrUUID:i.ProjDmndRsceAssgmtDistrUUID});this.deleteResource.call(this,s);if(i.ProjDmndRsceReqDistrUUID){s.sKey=e.createKey("/A_ProjDmndRsceReqDistribution",{ProjDmndRsceReqDistrUUID:i.ProjDmndRsceReqDistrUUID});this.deleteResource.call(this,s)}}await this.batchChange({oModel:e,mParameters:{groupId:"BatchDelete"}})}else if(r.length>0){this._updateRequest()}},_batchRequestCompleted:async function(e){var t=this.getModel("ProjectDemand");if(e.getSource().getDeferredGroups()[0]==="BatchDelete"){this._updateRequest()}else if(e.getSource().getDeferredGroups()[0]==="BatchUpdate"){t.detachBatchRequestCompleted(this._batchRequestCompleted,this);var r=this.getModel("message"),a=r.getData()[r.getData().length-1],s=this.getModel("detailView").getProperty("/aChangedSPath"),i=e.getParameters().success;for(var n in s){var l=s[n];if(!l.bTimeRecUpdate){sap.ui.getCore().byId(l.inputId).setValue("")}}this.getModel("detailView").setProperty("/aChangedSPath",[]);this.getModel("detailView").setProperty("/aDeletion",[]);await this._fetchResources(this.oContextObj);this.getView().getModel("detailView").refresh(true);if(i){o.success("Record saved")}else{o.error("Failed to update")}this.getModel("detailView").setProperty("/busy",false)}},_updateRequest:async function(){var e=this.getModel("ProjectDemand"),t=this.getModel("detailView"),r={},a=t.getProperty("/aChangedSPath");r.mParameters={groupId:"BatchUpdate",changeSetId:"changeSetId2",headers:{"X-CSRF-Token":this.csrfToken}};r.oModel=e;e.setDeferredGroups(["BatchUpdate"]);for(var s in a){var o=a[s],i=t.getProperty("/selectedView")==="DAY"&&!o.bTimeRecUpdate?Math.round(o.value*8).toString():o.value.toString();r.sKey=e.createKey("/A_ProjDmndRsceAssgmtDistr",{ProjDmndRsceAssgmtDistrUUID:o.ProjDmndRsceAssgmtDistrUUID});r.oPayload={ProjDmndRsceAssgmtDistrQty:i};this.updateResource(r);if(!o.bTimeRecUpdate){r.sKey=e.createKey("/A_ProjDmndRsceReqDistribution",{ProjDmndRsceReqDistrUUID:o.ProjDmndRsceReqDistrUUID});r.oPayload={ProjDmndRsceReqDistrQuantity:i};this.updateResource(r)}}await this.batchChange({oModel:e,mParameters:{groupId:"BatchUpdate"}})},_returnMthDist:function(e){var t=+e.aEmpRemaingDays.reduce((e,t)=>e+ +t.PlndEffortQty,0);return{...e,...{WorkPackage:e.WorkPackage,Name:this.formatter.returnDataFormat("MMM yyyy").format(new Date([e.YearMth.substr(0,4),e.YearMth.substr(4,2),"01"].join("-"))),YearMth:e.YearMth,TimeRecordings:+e.RecordedQuantity>0?+e.RecordedQuantity:null,Staffed:+e.PlndEffortQty,UnassignedCap:!e.preMth?+e.AvailabilityInHours-t:null,Writeoffs:e.WriteOffs,bLink:e.bLink,bInputVisible:e.bInputVisible,nProjectAssigned:t}}},_calculateValues:function(e){e.Staffed=e.Node.map(e=>e.Staffed).reduce((e,t)=>+e+ +t,0)||null;e.TimeRecordings=e.Node.map(e=>e.TimeRecordings).reduce((e,t)=>+e+ +t,0)||null;e.UnassignedCap=e.Node.map(e=>e.UnassignedCap).reduce((e,t)=>+e+ +t,0);e.Writeoffs=e.Node.map(e=>e.Writeoffs).reduce((e,t)=>+e+ +t,0)||null}})});
//# sourceMappingURL=Detail.controller.js.map